;(function($,window,document){$.fn.waterfall=function(options){var opts=$.extend({},$.fn.waterfall.defaults,options),ajaxTimes=0,isLoading=false,isFinish=false,colsHeight=[],minColsIndex=0,jsonCache=[],wf_box_top=0,wf_item_top=0,wf_item_left=0,$wf_box,$wf_col,$wf_col_temp,$wf_col_items,$wf_result,$backTop,ajaxFunc=$.isFunction(opts.ajaxFunc)?opts.ajaxFunc:function(success,error){$.ajax({type:'GET',url:opts.url,cache:false,data:opts.params,dataType:'json',timeout:60000,success:success,error:error})},createHtml=$.isFunction(opts.createHtml)?　opts.createHtml　:function(data){return'<div class="wf_item_inner">'+'<a href="'+data.href+'" class="thumb" target="_blank">'+'<img class="'+opts.imgClass+'"  src="'+data.imgSrc+'" />'+'</a>'+'<h3 class="title"><a href="'+data.href+'" target="_blank">'+data.title+'</a></h3>'+'<p class="desc">'+data.describe+'</p>'+'</div>'};function getJSONData(){if(!(isFinish||isLoading)){if(colsHeight.minHeight+wf_box_top<$(window).height()+$(window).scrollTop()){if(jsonCache.length>0){dealData()}else{if(opts.ajaxTimes==='infinite'||ajaxTimes<opts.ajaxTimes){showMsg('loading');opts.params.ajax=++ajaxTimes;ajaxFunc(function(jsonData){try{if(typeof jsonData==='string')jsonData=$.parseJSON(jsonData);if($.isEmptyObject(jsonData)||typeof jsonData==='string'){showMsg('finish')}else{jsonCache=jsonCache.concat(jsonData).reverse();dealData()}}catch(e){showMsg('error')}},function(){showMsg('error')})}else{showMsg('finish')}}}}}function dealData(){var perNum=typeof opts.perNum==='number'?opts.perNum:opts.colNum,data=null,wf_col_height=$wf_col.height(),$wf_item,$wf_img,htmlStr;loadImg(jsonCache,opts.imgUrlName,function(){while(perNum-->0&&(data=jsonCache.pop())){minColsIndex=getColsIndex(colsHeight)[0];wf_item_left=minColsIndex*(opts.colWidth+opts.marginLeft);wf_item_top=colsHeight[minColsIndex]+opts.marginTop;htmlStr=createHtml(data);$wf_item=$('<div>').addClass(opts.itemClass).html(htmlStr).css({width:opts.colWidth,left:wf_item_left,top:wf_item_top}).appendTo($wf_col);$wf_img=$wf_item.find('.'+opts.imgClass);$wf_img.height($wf_img.width()/data.width*data.height);if(opts.isAnimation){$wf_item.css({opacity:0}).animate({opacity:1},800)}colsHeight[minColsIndex]=wf_item_top+$wf_item.outerHeight();if(colsHeight[minColsIndex]>colsHeight.maxHeight){colsHeight.maxHeight=colsHeight[minColsIndex]}$wf_col.height(colsHeight.maxHeight)}isLoading=false;$wf_result.hide();getJSONData()})}function realign(){var colNum=0,i=0,backTop_left=0,speed=0;colNum=Math.floor(($wf_box.width()+opts.marginLeft)/(opts.colWidth+opts.marginLeft));if(colNum>0&&colNum!==opts.colNum){opts.colNum=colNum;$wf_col.width((opts.colWidth+opts.marginLeft)*opts.colNum-opts.marginLeft);for(i=0;i<opts.colNum;i++){colsHeight[i]=0}colsHeight.length=opts.colNum;$wf_col_items=$wf_col.children('.wf_item');$wf_col_items.each(function(num,value){minColsIndex=getColsIndex(colsHeight)[0];wf_item_top=colsHeight[minColsIndex]+opts.marginTop;wf_item_left=minColsIndex*(opts.colWidth+opts.marginLeft);if(opts.isAnimation)speed=300;$(this).width(opts.colWidth).animate({left:wf_item_left,top:wf_item_top},speed);colsHeight[minColsIndex]=wf_item_top+$(this).outerHeight()});getColsIndex(colsHeight);$wf_col.height(colsHeight.maxHeight);getJSONData()}}function showMsg(type){switch(type){case'loading':isLoading=true;$wf_result.html('').addClass('wf_loading').show();break;case'error':$wf_result.removeClass('wf_loading').show().html('数据格式错误，请返回标准的Json数据或Json格式字符串！');isFinish=true;break;case'finish':$wf_result.removeClass('wf_loading').show().html('已加载完毕，没有更多了！');isFinish=true;break}}return this.each(function(){if($(this).data('_wf_is_done_'))return true;$wf_box=$(this).addClass('waterfall').data('_wf_is_done_',true);wf_box_top=$wf_box.offset().top;$wf_col=$wf_box.children('.wf_col');$wf_col.length===0&&($wf_col=$('<div>').addClass('wf_col').appendTo($wf_box));$wf_result=$('<div>').addClass('wf_result').appendTo($wf_box);$(document.body).css('overflow','scroll');realign();$(document.body).css('overflow','auto');getJSONData();$(window).bind('scroll',function(){getJSONData()}).bind('resize',function(){throttle(realign)})})};$.fn.waterfall.defaults={itemClass:'wf_item',imgClass:'thumb_img',colWidth:235,marginLeft:15,marginTop:15,perNum:'auto',isAnimation:true,ajaxTimes:'infinite',imgUrlName:'img_list',params:{},url:'',ajaxFunc:null,createHtml:null};var imgReady=(function(){var list=[],intervalId=null,tick=function(){var i=0;for(;i<list.length;i++){list[i].end?list.splice(i--,1):list[i]()};!list.length&&stop()},stop=function(){clearInterval(intervalId);intervalId=null};return function(url,ready,load,error){var check,width,height,newWidth,newHeight,img=new Image();if(!url){error&&error();return}img.src=url;if(img.complete){ready(img.width,img.height);load&&load(img.width,img.height);return};width=img.width;height=img.height;check=function(){newWidth=img.width;newHeight=img.height;if(newWidth!==width||newHeight!==height||newWidth*newHeight>1024){ready(newWidth,newHeight);check.end=true}};check();img.onerror=function(){error&&error();check.end=true;img=img.onload=img.onerror=null};img.onload=function(){load&&load(img.width,img.height);!check.end&&check();img=img.onload=img.onerror=null};if(!check.end){list.push(check);if(intervalId===null)intervalId=setInterval(tick,40)}}})();function loadImg(jsonData,imgUrlName,callback){var count=0,i=0,intervalId=null,data=null,imgSrc=done=function(){if(count===jsonData.length){clearInterval(intervalId);callback&&callback()}};for(;i<jsonData.length;i++){data=jsonData[i];data.height=parseInt(data.height)||-1;data.width=parseInt(data.width)||-1;if(data.height>=0&&data.width>=0){++count}else{(function(data){imgReady(data[imgUrlName],function(width,height){data.width=width;data.height=height;++count},null,function(){data.width=20;data.height=20;data.imgSrc='images/default.jpg';++count})})(data)}}intervalId=setInterval(done,40)}function throttle(method,context){clearTimeout(method.tid);context=context||null;method.tid=setTimeout(function(){method.call(context)},100)}function getColsIndex(arr){var clone=arr.slice(),ret=[],len=arr.length,i,j,temp;for(i=0;i<len;i++){ret[i]=i}for(i=0;i<len;i++){for(j=i;j<len;j++){if(clone[j]<clone[i]){temp=clone[i];clone[i]=clone[j];clone[j]=temp;temp=ret[i];ret[i]=ret[j];ret[j]=temp}}}arr.minHeight=arr[ret[0]];arr.maxHeight=arr[ret[ret.length-1]];return ret}})(jQuery,window,document);