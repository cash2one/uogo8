/**
 * Created by Sky on 2015/12/11.
 */
(function ($, window, document) {

    function emoji_fn(option) {
		var options = $.extend({showTab: true,icons: [],btn:""},option),f={},emoji_box=null,emoji_input=null,emoji_cursor=0;
		//创建UI
		f.creatViews = function(){
            var showTab = options.showTab,iconsGroup = options.icons,groupLength = iconsGroup.length;
            if (groupLength === 0) {
                return false;
            };
            var emoji_container = '<div class="emoji_container">';
            var emoji_content = '<div class="emoji_content">';
            var emoji_tab = '<div class="emoji_tab" style="' + (groupLength === 1 && !showTab ? 'display:none;' : '') + '"><div class="emoji_tab_list"><ul>';
            var panel,name,path,maxNum;
            for (var i = 0; i < groupLength; i++) {
				name = iconsGroup[i].name || 'group' + (i + 1);
                path = iconsGroup[i].path;
                maxNum = iconsGroup[i].maxNum;
                if (!path || !maxNum) {
                    continue;
                };
                panel = '<div class="emoji_icons" style="' + (i === 0 ? '' : 'display:none;') + '" data-isload=false></div>';
                emoji_content += panel;
                emoji_tab += '<li data-tab="' + i + '" class="' + (i === 0 ? 'selected' : '') + '">' + name + '</li>';
            };
            emoji_content += '</div><div class="emoji_close">返回</div>';
            emoji_tab += '</ul></div></div>';
            emoji_container += emoji_content;
            emoji_container += emoji_tab;
			emoji_box = $(emoji_container).appendTo($('body'));
			//绑定按钮功能
			emoji_box.find(".emoji_close").click(function(){emoji_box.hide()});
			emoji_box.find("[data-tab]").on("click",function(){
				emoji_box.find("[data-tab]").removeClass("selected");
				$(this).addClass("selected");
				var ix = $(this).data("tab");
				emoji_box.find(".emoji_icons").hide().eq(ix).show();
				emoji_box.find(".emoji_icons").eq(ix).data("isload") == false && f.creatEmoji(ix)
				
			});
			emoji_box.on("click",".emoji_list_li",function(){
				f.insertAtCursor($(this).html());
				emoji_box.hide();
			});
			f.creatEmoji(0);

		};
		f.creatEmoji = function(i){
			var iconsGroup = options.icons,
                path = iconsGroup[i].path;
                maxNum = iconsGroup[i].maxNum;
                excludeNums = iconsGroup[i].excludeNums;
                file = iconsGroup[i].file || '.jpg',panel="<ul>";

                for (var j = 1; j <= maxNum; j++) {
                    if (excludeNums && excludeNums.indexOf(j) >= 0) {
                        continue;
                    };

                    panel += '<li class="emoji_list_li"><img src="' + path + j + file + '" class="emoji_icon" /></li>';
                };
				panel += "</ul>";
				emoji_box.find(".emoji_icons").eq(i).data("isload",true).append(panel);
				
		};
		//绑定按钮点击事件
		f.btnClickBind = function(){
			$(document).on("click",options.btn,function(){
				emoji_input = $(this).prev().get(0);
				emoji_box.toggle();
			})
		};
		//插入到编辑器
		f.insertAtCursor = function ( text) {
			 var obj = emoji_input;
			 //(!that.hasfocus) &&  that.focus();
			 obj.innerHTML += text;
			 if (window.getSelection) {//ie11 10 9 ff safari
                obj.focus(); //解决ff不获取焦点无法定位问题
                var range = window.getSelection();//创建range
                range.selectAllChildren(obj);//range 选择obj下所有子内容
                range.collapseToEnd();//光标移至最后
            }
/*            else if (document.selection) {//ie10 9 8 7 6 5
                var range = document.selection.createRange();//创建选择对象
                //var range = document.body.createTextRange();
                range.moveToElementText(obj);//range定位到obj
                range.collapse(false);//光标移至最后
                range.select();
            }*/

        };
		f.btnClickBind();f.creatViews();
    };
    $.emoji = emoji_fn;

}(Zepto, window, document));

