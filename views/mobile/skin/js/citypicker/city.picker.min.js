(function ($,window) {
	function baseUrl(){
		var scriptSrc = document.getElementsByTagName('script')[document.getElementsByTagName('script').length -1].src;
		var jsName = scriptSrc.split('/')[scriptSrc.split('/').length-1];
		return scriptSrc.replace(jsName,'');
	};
	var baseUrl = baseUrl(),
	ChineseAddressData = null,
	fileref = document.createElement('link');
	fileref.setAttribute("rel","stylesheet");
	fileref.setAttribute("type","text/css");
	fileref.setAttribute("href",baseUrl +"city.picker.css?"+Math.random());
	document.getElementsByTagName("head")[0].appendChild(fileref);


	$.get(baseUrl +"city.picker.data.js",function(data){
		ChineseAddressData = (new Function("","return "+ data))();
		//console.log(typeof ChineseAddressData)
		if (typeof ChineseAddressData == null) {
			throw new Error('"city.picker.data" 地址库没有被载入!');
		};
		
		$('.citypicker').citypicker();
	});

    function CityPicker(element, options) {
        this.$elem = element;
		this.$wrap = null;
		this.$list = null;
        this.options = options;
		this.addressData = ChineseAddressData;
		this.value = [];
		this.code = 86;
        this.init();
    };

    CityPicker.prototype = {

        init: function () {
			var _t = this;
			this.$wrap == null && (this.$wrap = $('<div class="city-picker-wrap"></div>').appendTo("body"));
			this.$wrap.css("min-height",$(document.body).height()+20);
			$("<p>返回</p>").appendTo(this.$wrap).click(function(){_t.btnBack()});
			this.$state = $('<div class="city-picker-state"></div>').appendTo(this.$wrap);
			this.$list = $('<dl class="city-picker-list"></dl>').appendTo(this.$wrap);
			
			this.$info = $('<div class="city-picker-info">请选择您所在的城市</div>').appendTo(this.$wrap);
			this.$elem.click(function(){_t.restart()}).attr({"readonly":true,"placeholder":this.options.placeholder})
			//console.log(this.addressData[86].length)
			
        },
        render: function () {
			var _this = this,doms = this.$list.empty();
			$.each(this.getData(),function(i,v){
					if(_this.code == 86){_this.$list.append('<dt>'+i+'</dt>')} else {v = [{code:i,address:v}]};
					
					$.each(v,function(ii,vv){
						$('<dd>').data("code",vv.code).data("address",vv.address).html("<em>&gt;</em>"+ vv.address).
						click(function(){
							_this.code = $(this).data("code");
							_this.value.push($(this).data("address"));
							_this.renderClick();
						}).
						appendTo(doms);
					})
					//console.log(i)
			});
        },
		renderClick:function(){
			//console.log(this.code)
			$(document.body).scrollTop(0);
			this.$state.html(this.value.join("/") || this.$elem.val() || this.options.placeholder);
			this.value.length>0 && (this.$elem.val(this.value.join("/")));
			this.render();
		},
		getData:function(){
			if(!this.addressData[this.code]){
				this.$wrap.hide();return []
			};
			return this.addressData[this.code];
		},
		btnBack:function(){
			this.restart();
			this.$list.find("dt").length>0 && (this.$wrap.hide());
		},
		restart:function(){
				this.$wrap.show();
				this.code = 86;
				this.value= [];
				this.renderClick()
		}
    };
    $.fn.citypicker = function (option) {
		var options = $.extend({
			placeholder: '请选择省/市/区'
		}, option);
        return this.each(function () {
            return new CityPicker($(this), options)
        });
    };
	
})(Zepto,window);